<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.antonio.example.springtddmybatis.mapper.PersonMapper">
    <insert id="save"></insert>

    <select id="findByCpf" resultType="com.antonio.example.springtddmybatis.model.Person">
        SELECT * FROM PERSON WHERE CPF = #{cpf}
    </select>

    <select id="findByTelephoneDddAndTelephoneNumber" resultType="com.antonio.example.springtddmybatis.model.Person">
        <include refid="queryInner"></include>
        WHERE T.ddd = #{ddd}
        AND T.number = #{number}
    </select>

    <sql id="queryInner">
        SELECT
        P.id AS id, P.cpf AS cpf, P.name AS name
        FROM PERSON P
        INNER JOIN TELEPHONE T ON T.person_id = P.id
    </sql>

    <select id="filter" resultType="com.antonio.example.springtddmybatis.model.Person">

        <include refid="queryInner"></include>
        WHERE 1 = 1

        <if test="personFilter != null and personFilter.name != null">
            <bind name="filterName" value=" '%' + personFilter.name + '%'" />
            AND P.name like #{filterName}
        </if>

        <if test="personFilter != null and personFilter.cpf != null">
            <bind name="filterCpf"  value="'%' + personFilter.cpf + '%'" />
            AND P.cpf like #{filterCpf}
        </if>

        <if test="personFilter != null and personFilter.ddd != null">
            AND T.ddd like #{personFilter.ddd}
        </if>

        <if test="personFilter != null and personFilter.number != null">
            AND T.number like #{personFilter.number}
        </if>
    </select>

</mapper>